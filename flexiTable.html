<!-- flexiTable.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Flexible Table with Dynamic Filters</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: Lato, sans-serif;
            font-size: 13px;
        }
    </style>
    <link rel="stylesheet" href="flexiTable.css">
</head>

<body>
    <!-- Dropdown for selecting the data method -->
    <select id="dataFileSelector">
        <option value="intervalsByEntity">Intervals by Entity</option>
        <option value="intervalsByUser">Intervals by User</option>
        <option value="totalsByEntity">Totals by Entity</option>
        <option value="totalsByUser">Totals by User</option>
    </select>
    <button id="refreshDataButton">Refresh Data</button>

    <div id="filtersDiv"></div>
    <div id="tableContainer" style="width: 80%;"></div>

    <script type="module">
        import { FlexiTable } from './flexiTable.js';
        import { FilterManager } from './filterManager.js';
        import { EffortTransformer } from './effortTransformer.js';

        const dataFileSelector = document.getElementById('dataFileSelector');
        const tableContainer = document.getElementById('tableContainer');
        let effortTransformer;

        const defaultDataMethod = 'transformToIntervalsByEntity';
        dataFileSelector.value = localStorage.getItem('selectedDataMethod') || defaultDataMethod;

        let flexiTable; 
        let filterManager;

        document.addEventListener('DOMContentLoaded', () => {
            changeDataMethod(); 
            dataFileSelector.addEventListener('change', changeDataMethod);

            const refreshButton = document.getElementById('refreshDataButton');
            refreshButton.addEventListener('click', () => {
                // This is just to demonstrate how to refresh the data
                document.dispatchEvent(new CustomEvent('dataUpdated', { detail: flexiTable.dataset }));
            });
        });

        async function changeDataMethod() {
            const selectedMethod = dataFileSelector.value;
            localStorage.setItem('selectedDataMethod', selectedMethod);
            const responseModule = selectedMethod.includes('intervals') ? './tests/dataSamples/responseResourceAnalysisIntervals.js' : './tests/dataSamples/responseResourceAnalysisTotals.js';

            const { default: responseData } = await import(responseModule);
            effortTransformer = new EffortTransformer(responseData);

            let data;
            switch (selectedMethod) {
                case 'intervalsByEntity':
                    data = effortTransformer.transformToIntervalsByEntity();
                    break;
                case 'intervalsByUser':
                    data = effortTransformer.transformToIntervalsByUser();
                    break;
                case 'totalsByEntity':
                    data = effortTransformer.transformToTotalsByEntity();
                    break;
                case 'totalsByUser':
                    data = effortTransformer.transformToTotalsByUser();
                    break;
            }

            tableContainer.innerHTML = ''; // Clear previous table contents

            flexiTable = new FlexiTable('tableContainer', data); // Re-create the flexiTable instance here
            
            window.flexiTable = flexiTable; // Assign to window object to access from outside. 
            
            document.getElementById('filtersDiv').innerHTML = '';
            filterManager = new FilterManager('filtersDiv', {
                project: true, workItem: true, user: true
            });
        }
    </script>

</body>

</html>